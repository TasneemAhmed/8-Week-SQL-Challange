/* first need to show the prize of every pizza type
Ex: Meatlovers  12
    Vegetarian 10 */
with cte_1 as(
  SELECT *,
  CASE
  	WHEn pn.pizza_name = 'Meatlovers' THEN 12
  	when pn.pizza_name = 'Vegetarian' THEN 10
    ELSE 0
  END as pizza_price
  from customer_orders c 
  join pizza_names pn 
  on c.pizza_id = pn.pizza_id
),
/* get runner revenue : sum pizza prices for each runner_id */
cte_2 as(
  SELECT r.runner_id, sum(cte_1.pizza_price) as total_revenue_runner
  from cte_1 cte_1
  join runner_orders r 
  on cte_1.order_id = r.order_id
  GROUP by 1
)
SELECT * from cte_2;

/****************************************************************************/
/*get row number for every row in customer_orders table*/
with row_number_cte as(
  SELECT 
  ROW_NUMBER() OVER() as row_number,
  *
  from customer_orders
),
/*split extras to make every extra ordered in single record
ex: pizza_id   extras
	1            1,5
    will be:
    pizza_id   extras
	1            1
    1            5
*/
cte_extra(row_number, extra, extras) AS(
  SELECT row_number, '', extras||',' FROM row_number_cte
  WHERE extras != '' and extras != 'null'
  UNION ALL
  SELECT 
  row_number,
  substr(extras, 0, instr(extras, ',')),
  substr(extras, instr(extras, ',')+1)
  FROM cte_extra
  WHERE extras != ''
),
/**adjust the extra ordered price: if no extra, set the price 0
if order has extra, every extra price = 1 */
extra_price AS(
  SELECT row_number, 
  extra,
  CASE 
  	WHEn extra != '' THEN 1
    ELSE 0
  END as extra_price
  
  FROM cte_extra
),
/*sum the price of extras per row_number*/
extras_price as(
  SELECT row_number,
  sum(extra_price) as sum_extras
  from extra_price
  GROUP by 1
),
/* show the prize of every pizza type
Ex: Meatlovers  12
    Vegetarian 10 */
pizza_price as(
  SELECT r.*,
  CASE
  	WHEn pn.pizza_name = 'Meatlovers' THEN 12
  	when pn.pizza_name = 'Vegetarian' THEN 10
    ELSE 0
  END as pizza_price
  from row_number_cte r
  join pizza_names pn 
  on r.pizza_id = pn.pizza_id
),
/* join with table has pizzs_price with extra price to have every order */
extra_pizza_price as(
  SELECT pp.*, 
  CASE 
  	WHEN ep.sum_extras != '' THEN ep.sum_extras
    ELSE 0
  END as extras_price
  from pizza_price pp
  LEFT join extras_price ep
  on pp.row_number = ep.row_number
),
/* get runner revenue : sum (pizza prices + extra price) for each runner_id */
output_cte as(
  SELECT r.runner_id, sum(cte.pizza_price + cte.extras_price) as total_revenue_runner
  from extra_pizza_price cte
  join runner_orders r 
  on cte.order_id = r.order_id
  GROUP by 1
)
SELECT * from output_cte;