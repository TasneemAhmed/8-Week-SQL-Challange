with cteSplit_4(pizza_id, order_time, exclusion, exclusions) AS(
  SELECT pizza_id, order_time, '', exclusions||',' from customer_orders
  WHERE exclusions != '' and exclusions != 'null'
  UNION ALL
  SELECT 
  pizza_id,
  order_time,
  substr(exclusions, 0, instr(exclusions, ',')),
  substr(exclusions, instr(exclusions, ',')+1)
  FROM cteSplit_4
  WHERE exclusions != ''
),

ingredients_details as (
  SELECT cte_4.pizza_id, cte_4.order_time, cte_4.exclusion, pt.topping_name
  FROM cteSplit_4 cte_4
  JOIN pizza_toppings pt
  on cte_4.exclusion = pt.topping_id)

SELECT *
from ingredients_details;

 SELECT * 
 FROM customer_orders c
 JOIN pizza_names pn
 on c.pizza_id = pn.pizza_id
 JOIN ingredients_details ing
on c.pizza_id = ing.pizza_id;



/***********************/
with join_toppings as(
  SELECT * 
  from customer_orders c
  join pizza_recipes pr
  on c.pizza_id = pr.pizza_id
),

cteSplit_topping(pizza_id, topping, toppings) AS(
  SELECT pizza_id, '', toppings||',' from join_toppings
  UNION ALL
  SELECT
  pizza_id,
  substr(toppings, 0, instr(toppings, ',')),
  substr(toppings, instr(toppings, ',')+1)
  FROM cteSplit_topping
  WHERE toppings != ''
),
cte_toppings as(
  SELECT cte_t.pizza_id, cte_t.topping, pt.topping_name
  from cteSplit_topping cte_t
  join pizza_toppings pt
  on cte_t.topping = pt.topping_id
  and cte_t.topping != ''
),

count_toppings AS(
  SELECT topping, COUNT(topping) as count_toppings
  from cte_toppings
  GROUP by 1
),
/*****************/
cteSplit_exclusions(exclusion, exclusions) AS(
  SELECT '', exclusions||',' from customer_orders
  WHERE exclusions != '' and exclusions != 'null'
  UNION ALL
  SELECT 
  substr(exclusions, 0, instr(exclusions, ',')),
  substr(exclusions, instr(exclusions, ',')+1)
  FROM cteSplit_exclusions
  WHERE exclusions != ''
),

count_exclusions AS(
  SELECT exclusion, COUNT(exclusion) * -1 as count_exclusions
  FROM cteSplit_exclusions
  WHERE exclusion != ''
  GROUP by 1
),
/*********************************/
cteSplit_extras(extra, extras) AS(
  SELECT '', extras||',' from customer_orders
  WHERE extras != '' and extras != 'null'
  UNION ALL
  SELECT 
  substr(extras, 0, instr(extras, ',')),
  substr(extras, instr(extras, ',')+1)
  FROM cteSplit_extras
  WHERE extras != ''
), 

count_extras as(
  SELECT extra, COUNT(extra) as count_extras
  FROM cteSplit_extras
  WHERE extra != ''
  GROUP by 1),

/************************/
union_ctes as (
  SELECT * from count_toppings
  UNION ALL 
  select * from count_exclusions
  UNION ALL
  SELECT * from count_extras)
  
SELECT pt.topping_name, sum(ctes.count_toppings) as topping_times_used
from union_ctes ctes
JOIN pizza_toppings pt
on ctes.topping = pt.topping_id
GROUP by pt.topping_name
ORDER by 2 DESC;

